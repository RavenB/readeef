{% define "content" %}
<link rel="import" href="/dist/paper-button/paper-button.html">
<link rel="import" href="/dist/paper-dialog/paper-dialog-transition.html">
<link rel="import" href="/dist/paper-dialog/paper-dialog.html">
<link rel="import" href="/dist/paper-input/paper-input.html">

<link rel="import" href="/component/rf-api">

<polymer-element name="rf-dialog-add-feed" attributes="wide user">
    <template>
        <paper-dialog id="add-feed-dialog" heading="Add feed" transition="paper-dialog-transition-center" backdrop on-core-overlay-open="{{ onOpen }}" closeSelector="[dismissive],[affirmative]:not([transient])">
            <template if="{{ !feeds }}">
                <p>Enter the address of a feed, or a website that might contain one or more feeds.</p>

                <paper-input label="URL" id="feed-url" value="{{ url }}"></paper-input>
            </template>
            <template if="{{ feeds && !feeds.length }}">
                <p>No feeds found for '{{url}}'</p>
            </template>
            <template if="{{ feeds && feeds.length }}">
                <p>Found the following feeds for '{{url}}':</p>
                <ul>
                <template repeat="{{feed in feeds}}">
                    <li><a href="{{ feed.Link }}">{{ feed.Title }}: {{ feed.Description}}</a></li>
                </template>
                </ul>
            </template>

            <paper-button label="Cancel" affirmative></paper-button>
            <paper-button label="Find" on-tap="{{ onFind }}" id="find-feeds" affirmative transient autofocus disabled?="{{ !url }}" hidden?="{{ feeds }}"></paper-button>
            <paper-button label="Add" on-tap="{{ onAdd }}" id="add-feeds" affirmative transient autofocus hidden?="{{ !feeds || !feeds.length }}"></paper-button>
        </paper-dialog>

        <rf-api user="{{ user }}" id="discover" pathAction="feed/discover" on-core-response="{{ onDiscoverResponse }}"></rf-api>
        <rf-api user="{{ user }}" id="add" pathAction="feed/add" on-core-response="{{ onAddResponse }}"></rf-api>
    </template>
    <script>
(function() {
    "use strict";

    Polymer('rf-dialog-add-feed', {
        loading: false,

        created: function() {
            this.feeds = null;
        },

        toggle: function() {
            this.$['add-feed-dialog'].toggle();
        },

        onOpen: function() {
            this.url = "";
            this.feeds = null;
        },

        onFind: function() {
            this.$.discover.params = JSON.stringify({"url": this.url});
            this.$.discover.go();
            this.loading = true;
        },

        onAdd: function() {
            var params = {url: []};
            for (var i = 0, f; f = this.feeds[i]; ++i) {
                params.url.push(f.Link);
            }

            this.$.add.params = JSON.stringify(params)
            this.$.add.go();
            this.loading = true;
        },

        onDiscoverResponse: function(event, data) {
            if (data.response) {
                this.feeds = data.response.Feeds;
            } else {
                this.feeds = [];
            }
            this.loading = false;
        }
    });
})();
    </script>
</polymer-element>
{% end %}
